<!-- Main content -->
<section class="content">

		<div class="box box-primary">
	        <form id="boxType-search-form" action="" class="form-horizontal" method="post">
	        <div class="box-body">
	          	<div class="col-sm-4">
		          	<div class="form-group">
						<label class="col-sm-4 control-label">纸盒名称</label>
							<div class="col-sm-8">
								<input id="search-boxName" name="search-boxName" type="text" class="form-control"
								placeholder="请输入纸盒名称">
							</div>
					</div>
				</div>
				
				<div class="col-sm-4">
					<div class="form-group">
						<label class="col-sm-4 control-label">纸盒类型</label>
						<div class="col-sm-8">
							<select name="search-type" id="search-type" class="form-control"> </select>
						</div>	
					</div>
                </div>
				
	        </div>
	        </form>
	        
	        <!-- /.box-body -->
	        <div class="box-footer">
	        	<div class="row">
	          	<div id="boxTypebar" class="btn-toolbar">
					<div class="btn-group pull-left">
						<button type="button" data-btn-type="add" class="btn btn-success"><i class="fa fa-plus"></i>新增</button>
						<button type="button" data-btn-type="edit" class="btn btn-warning"><i class="fa fa-edit"></i>编辑</button>
						<button type="button" data-btn-type="delete" class="btn btn-danger"><i class="fa fa-remove"></i>删除</button>
						<button type="button" data-btn-type="scan" class="btn btn-info"><i class="fa fa-search-plus"></i>查看</button> 
					</div>

					<div class="btn-group pull-right">
						<button type="button" data-btn-type="search" class="btn btn-primary"><i class="fa fa-search"></i>查询</button>
						<button type="button" data-btn-type="reset" class="btn btn-default"><i class="fa fa-reply"></i>重置</button>
					</div>
				</div>
				</div>
				<div class="row">
					<table id="boxType-table" data-toggle="table" data-url="boxmanage/boxTypeList" data-toolbar="#boxTypebar" data-pagination="true" data-search="false"
						data-striped="true" data-show-export="true" data-page-size="10" data-click-to-select="true">
						<thead>
							<tr>
								<th data-checkbox="true" class="select-checkbox"></th>
								<th data-align="center" data-field="name" data-sortable="true">纸盒名称</th>
								<th data-align="center" data-field="className" data-sortable="true" >纸盒类型</th>
								<th data-align="center" data-field="description" data-sortable="true">纸盒描述</th>
								<th data-align="center" data-field="createtime" data-sortable="true" data-formatter="formatteryyyyMMddHHmmss">创建时间</th>
							</tr>
						</thead>
					</table>
				</div>
	        </div>
	        <!-- /.box-footer-->
      </div>
</section>

<!-- 新增弹窗 -->
<div class="modal fade col-xs-12" id="modal-boxType" aria-labelledby="modalBoxTypeLabel" aria-hidden="true">
	<div class="modal-dialog" style="width:800px">
		<div class="modal-content">
			<form class="form-horizontal" action="" id="boxType-form"  enctype="multipart/form-data" method="post">
				<input type="hidden" id="flag" name="flag">
				<input type="hidden" id="boxid" name="boxId">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">×</button>
					<h4 class="modal-title" id="modalBoxTypeLabel"></h4>
				</div>
				<div class="modal-body">
                  <div class="col-sm-6">
                    <div class="form-group">
						<label class="col-sm-4 control-label">纸盒名称<span style="color: red;">*</span></label>
						<div class="col-sm-8">
							<input id="name" name="name" type="text" class="form-control"
								placeholder="请输入纸盒类型名称">
						</div>
					</div>
					
					<div class="form-group">
						<label class="col-sm-4 control-label">纸盒类型<span style="color: red;">*</span></label>
						<div class="col-sm-8">
							<select name="classId" id="classId" class="form-control"> </select>
						</div>
					</div>
					
					<div class="form-group" id="xijie1"  style="display:none">
						<label class="col-sm-4 control-label" id="detail1-label">细节1<span style="color: red;">*</span></label>
						<div class="col-sm-8">
							<select name="detail1" id="detail1" class="form-control"> </select>
						</div>
					</div>
						
					<div class="form-group" id="xijie2"  style="display:none">
						<label class="col-sm-4 control-label" id="detail2-label">细节2<span style="color: red;">*</span></label>
						<div class="col-sm-8">
							<select name="detail2" id="detail2" class="form-control"> </select>
						</div>
					</div>
					
				   <div class="form-group" id="xijie3"  style="display:none">
						<label class="col-sm-4 control-label" id="detail3-label">细节3<span style="color: red;">*</span></label>
						<div class="col-sm-8">
							<select name="detail3" id="detail3" class="form-control"> </select>
						</div>
					</div>
					
					<div class="form-group">
						<label class="col-sm-4 control-label">纸盒描述<span style="color: red;">*</span></label>
						<div class="col-sm-8">
							<input id="description" name="description" type="text" class="form-control"
								placeholder="请输入纸盒类型名称">
						</div>
					</div>
                  </div>
                  <div class="col-sm-6">
                    <div class="form-group">
						<label class="col-sm-4 control-label">纸盒长度最小值<span style="color: red;">*</span></label>
						<div class="col-sm-8 form-group"> 
						     <input  name="lmin" type="text" class="form-control"
								placeholder="请输入纸盒长度最小值" maxlength="5"><span>mm</span>
						 </div>
						
					</div>
					
					<div class="form-group">
						<label class="col-sm-4 control-label">纸盒长度最大值<span style="color: red;">*</span></label>
						<div class="col-sm-8 form-group">
							<input name="lmax" type="text" class="form-control"
								placeholder="请输入纸盒长度最大值"><span>mm</span>	
						</div>
					</div>
					
                    <div class="form-group">
						<label class="col-sm-4 control-label">纸盒宽度最小值<span style="color: red;">*</span></label>
						<div class="col-sm-8 form-group">
							<input name="wmin" type="text" class="form-control"
								placeholder="请输入纸盒宽度最小值"><span>mm</span>
						</div>
					</div>

                    <div class="form-group">
						<label class="col-sm-4 control-label">纸盒宽度最大值<span style="color: red;">*</span></label>
						<div class="col-sm-8 form-group">
							<input name="wmax" type="text" class="form-control"
								placeholder="请输入纸盒宽度最大值"><span>mm</span>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4 control-label">纸盒高度最小值<span style="color: red;">*</span></label>
						<div class="col-sm-8 form-group">
							<input name="hmin" type="text" class="form-control"
								placeholder="请输入纸盒高度最小值"><span>mm</span>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4 control-label">纸盒高度最大值<span style="color: red;">*</span></label>
						<div class="col-sm-8 form-group">
							<input name="hmax" type="text" class="form-control"
								placeholder="请输入纸盒高度最大值"><span>mm</span>
						</div>
                    </div>
                  </div>
                  <div class="row">
		                   <label for="" class="col-sm-4 control-label"  >立体图</label>
				  </div>
	              <div class="row">
	                  <div class="form-group">
	                         <input id="file-1" type="file" name="file-1"  class="file" data-overwrite-initial="false" data-min-file-count="1">
	                  </div>
				  </div>

				  <div class="row">
					   <div class="form-group">
		                     <label for="" class="col-sm-4 control-label">实物图</label>
					   </div>
			      </div>
                  <div class="row">
					    <div class="form-group">
	                         <input id="file-2" type="file" name="file-2"  class="file" data-overwrite-initial="false" data-min-file-count="1" >
	                    </div>
				  </div>

				  <div class="row">
		                <label for="" class="col-sm-4 control-label"  >平面展开图</label>

				  </div>
	              <div class="row">
	                  <div class="form-group" >
	                       <input id="file-3" type="file" name="file-3" class="file" data-overwrite-initial="false" data-min-file-count="1" >
	                  </div>
				  </div>
				  <div class="modal-footer">
						<button type="submit" class="btn btn-success" id="saveBtn"><i class="fa fa-save"></i>保存</button>
						<button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-close"></i>关闭</button>
				  </div>
				</div>
			</form>
		</div>
	</div>
</div>


<script src="${basePath}/assets/adminlte/plugins/bootstrap-table/bootstrap-table.js"></script>
<script src="${basePath}/assets/common/js/base.js"></script>

<script type="text/javascript">
$(function(){
	boxTypeForm = $("#boxType-form").form();
	boxTypeSearchForm = $("#boxType-search-form").form();
	setDetailIdSelect('search-type',null,"0");
	setDetailIdSelect('classId',null,"0");
	//-------------button event begin----------------
	$('button[data-btn-type]').click(function() {
		var selected = $('#boxType-table').bootstrapTable('getSelections');
		var action = $(this).attr('data-btn-type');
		switch (action) {
		case 'add':
			resetForm();
			$("#flag").val("1");
			$("#modalBoxTypeLabel").text("新增纸盒类型");
			$('#modal-boxType').modal('toggle');
			setFileStyle('file-1');
			setFileStyle('file-2');
			setFileStyle('file-3');
			$('#saveBtn').show();
			break;
		case 'edit':
			if(selected.length != 1){
				layer.alert('请选择要编辑的数据,每次只能选一条!');
				return false;
			}
			resetForm();
			$("#flag").val("2");
			$("#modalBoxTypeLabel").text("编辑纸盒类型");
			$("#modal-boxType").modal("toggle");
			$('#saveBtn').show();
			formEdit(selected[0],'1');
		   	break;
		case 'scan':
			if(selected.length != 1){
				layer.alert('请选择要编辑的数据,每次只能选一条!');
				return false;
			}
			resetForm();
			$("#flag").val("2");
			$("#modalBoxTypeLabel").text("查看");
			$("#modal-boxType").modal("toggle");
			$('#saveBtn').hide();//隐藏保存按钮
		    formEdit(selected[0],'2');
		   	break;
		case 'delete':
			if(selected.length < 1){
				layer.alert('请选择要删除的数据');
				return false;
			}
			layer.confirm("是否要删除该行数据？",function(){
				var rowIds = getIdSelections();
				ajaxPost(basePath + "/boxmanage/deleteBoxType", {
					boxIds:JSON.stringify(rowIds)
				}, function(data){
					layer.msg(data.code, {
						icon : 1,
						time : 1500,
				});
					$('#boxType-table').bootstrapTable('remove', { field: 'boxId', values: rowIds});
				});
				return true;
			})
			break;
		case 'search':
			var formParams = $("#boxType-search-form").serializeJSON();
			ajaxGet(basePath + "/boxmanage/boxTypeSearchList", {
				params:JSON.stringify(formParams)
			}, function(data) {
				$('#boxType-table').bootstrapTable('load',data);
			});	
			break;
		case 'reset':
			boxTypeSearchForm.clearForm();
			$('#boxType-table').bootstrapTable('refresh');
			break;

		}

	});
	//-------------button event end----------------
	
	//-------------Validator from begin----------------
	$("#boxType-form").bootstrapValidator({
		message : '请输入有效值',
		feedbackIcons : {
			valid : 'glyphicon glyphicon-ok',
			invalid : 'glyphicon glyphicon-remove',
			validating : 'glyphicon glyphicon-refresh'
		},
		fields : {
			name : {
				validators : {
					notEmpty : {
						message : '请输入纸盒类型名称'
					},
					threshold : 10,
					remote : {
						url : basePath + "/boxmanage/checkBoxTypeNameExists",
						message : '纸盒名称已存在',
						delay : 2000,
						type : 'POST'
					}
				}
			},
			classId : {
				validators : {
					notEmpty : {
						message : '请选择纸盒类型'
					}
				}
			},
			detail1 : {
				validators : {
					notEmpty : {
						message : '请选择纸盒局部细节'
					}
				}
			},
			description : {
				validators : {
					notEmpty : {
						message : '请输入纸盒描述'
					}
				}
			},
			lmax: {
				validators : {
					notEmpty : {
						message : '请输入纸盒长度最大值'
					}
				}
			},
			lmin : {
				validators : {
					notEmpty : {
						message : '请输入纸盒长度最小值'
					}
				}
			},
			wmax : {
				validators : {
					notEmpty : {
						message : '请输入纸盒宽度最大值'
					}
				}
			},
			wmin : {
				validators : {
					notEmpty : {
						message : '请输入纸盒宽度最小值'
					}
				}
			},
			hmax: {
				validators : {
					notEmpty : {
						message : '请输入纸盒高度最大值'
					}
				}
			},
			hmin : {
				validators : {
					notEmpty : {
						message : '请输入纸盒高度最小值'
					}
				}
			},
			dime : {
				validators : {
					notEmpty : {
						message : '请选择纸盒的立体图'
					}
				}
			},
			plan : {
				validators : {
					notEmpty : {
						message : '请选择纸盒的平面展开图'
					}
				}
			},
			phy : {
				validators : {
					notEmpty : {
						message : '请输入纸盒的实物图'
					}
				}
			},
			unit : {
				validators : {
					notEmpty : {
						message : '请选择单位'
					}
				}
			}
		},

        submitHandler: function (validator, form, submitButton) {
        	var myForm = document.getElementById('boxType-form');
        	formData = new FormData(myForm);
        	for(var pair of formData.entries()) {
        		   console.log(pair[0]+ ', '+ pair[1]); 
        	}
        
        	ajaxPostFile(basePath + "/boxmanage/editBoxType", formData,  function(data){
				$('#modal-boxType').modal('hide');
				layer.msg(data.code, {
					icon : 1,
					time : 1500,
				});
				$('#boxType-table').bootstrapTable('refresh');
        	});
        }
	});
	//-------------Validator from end----------------
	
	 $("#classId").change(function(){
		 var selected=$(this).children('option:selected').val()
			
	       if(selected!=""){
		 	   setXijieSelect(selected,"1");  
	       }else{
	    		$("#xijie1").hide(); 
	 	    	$("#xijie2").hide(); 
	 	    	$("#xijie3").hide(); 
	       }
	   });
});

	
	function resetForm(){
		boxTypeForm.clearForm();
		$("#boxType-form").data('bootstrapValidator').resetForm();
	}
	
	/*
	 * 得到所有选中行
	 */
	function getIdSelections() {
		return $.map($('#boxType-table').bootstrapTable('getSelections'),function(row) {
				return row.boxId;
		});
	}
	
	 /**
	  * 设置类型级别为0级的下拉列表
	  * @param selectid
	  * @returns
	  */
	 function setDetailIdSelect(selectid,groupid,level){
		var p=new Object();
		p.groupid=groupid;
		p.level=level;
	 	ajaxPost("boxmanage/getBoxClassLevelList", {
	 		params : JSON.stringify(p)
	 	}, function(data) {
	 		var $select = $('#'+selectid); 
	 		$select.empty();
	 		if(data.length==0){
	 			 $select.val("");
	 		}
	 		if(data.length>0){
	 			 $select.append('<option value="">请选择...</option>'); 
	 		}
	 		for(var i=0, len = data.length;i<len;i++){ 
	 		  var b=data[i];
	 		  var bid=b.id;
	 		  var bname=b.name;
	 		   $select.append('<option value="'+bid+'">'+bname+'</option>');  
	 		} 
	 	});
	 }
	 /**
	 * 设置联动下拉效果
	 */
	 function  setXijieSelect(groupid,level){
			var p=new Object();
			p.groupid=groupid;
			p.level=level;
		 	ajaxPost("boxmanage/getBoxClassLevelList", {
		 		params :  JSON.stringify(p)
		 	}, function(data) {
		 	    if(data.length<=0){
		 	    	$("#xijie1").hide(); 
		 	    	$("#xijie2").hide(); 
		 	    	$("#xijie3").hide(); 
		 	    }else if(data.length==1){
		 	    	$("#xijie1").show(); 
		 	    	$("#xijie2").hide(); 
		 	    	$("#xijie3").hide();
		 	    	$("#detail1-label").html(data[0].name+'<span style="color: red;">*</span>');
		 		    setDetailIdSelect('detail1',data[0].id,"2");
		 	    }else if(data.length==2){
		 	    	$("#xijie1").show(); 
		 	    	$("#xijie2").show(); 
		 	    	$("#xijie3").hide(); 
		 	     	$("#detail1-label").html(data[0].name+'<span style="color: red;">*</span>');
		 		    $("#detail2-label").html(data[1].name+'<span style="color: red;">*</span>');
		 		    setDetailIdSelect('detail1',data[0].id,"2");
		 		    setDetailIdSelect('detail2',data[1].id,"2");
		 	    }else if(data.length==3){
		 	    	$("#xijie1").show(); 
		 	    	$("#xijie2").show(); 
		 	    	$("#xijie3").show(); 
		 	    	$("#detail1-label").html(data[0].name+'<span style="color: red;">*</span>');
		 		    $("#detail2-label").html(data[1].name+'<span style="color: red;">*</span>');
		 		    $("#detail3-label").html(data[2].name+'<span style="color: red;">*</span>');
		 		    setDetailIdSelect('detail1',data[0].id,"2");
		 		    setDetailIdSelect('detail2',data[1].id,"2");
		 		    setDetailIdSelect('detail3',data[2].id,"2");
		 	    }
		 	});
		 }
	 /**
	 * 设置文件上传控件的效果
	 */
	function setFileStyle(fileId){
		$('#'+fileId).fileinput({
			language: 'zh', //设置语言
		    uploadUrl: '#', // you must set a valid URL here else you will get an error
		    //allowedFileTypes : [ 'image','video','flash','audio'],
		    allowedFileExtensions: ['jpg', 'png','jpeg', 'svg','gif','mpeg'],
		    overwriteInitial: false,
		    showUpload:false,
		    //mainClass: "input-group-lg",
		    dropZoneEnabled: false,//是否显示拖拽区域
		   // dropZoneTitle:'拖放文件到这里',
		    maxFileCount: 1,
		    layoutTemplates:{
		    	//actionDelete:'',
		    	actionUpload:'',
		    },
		    slugCallback: function (filename) {
		        return filename.replace('(', '_').replace(']', '_');
		    },
		 });
	}
	 
	//修改纸盒时回传数据
	function formEdit(data,operate) {
		setXijieSelect(data.classId,"1");
	    boxTypeForm.initFormData(data);
	    console.log(data);
	    dime=data.dime;
	    plan=data.plan;
	    phy=data.phy;

		orlist=new Array();//图片地址集合
		titlelist=new Array();//图片名称集合
		var t=new Object();
		t.width="120px";
    	t.key=0;
		    if(operate=='1'){
		    	console.log(window.document.location.href);
		    	var pa="images/BoxType";
		    	console.log(pa);
		    	    var path="images/BoxType/"+data.boxId;
		    	    orlist[0]=path+"/dime/"+dime;
		        	t.caption=dime;
		            titlelist[0]=t;	
		            setEditFileStyle('file-1',orlist,titlelist,dime);
		            orlist[0]=path+"/phy/"+phy;
		        	t.caption=phy;
		            titlelist[0]=t;	
		            setEditFileStyle('file-2',orlist,titlelist,phy);
		            orlist[0]=path+"/plan/"+plan;
		        	t.caption=plan;
		            titlelist[0]=t;	
		            setEditFileStyle('file-3',orlist,titlelist,plan);
		    	 
		    }else if(operate=='2'){
		    	    var path="images/BoxType/"+data.boxId;
		    	    orlist[0]=path+"/dime/"+dime;
		        	t.caption=dime;
		            titlelist[0]=t;	
		            setScanFileStyle('file-1',orlist,titlelist,dime);
		            orlist[0]=path+"/phy/"+phy;
		        	t.caption=phy;
		            titlelist[0]=t;	
		            setScanFileStyle('file-2',orlist,titlelist,phy);
		            orlist[0]=path+"/plan/"+plan;
		        	t.caption=plan;
		            titlelist[0]=t;	
		            setScanFileStyle('file-3',orlist,titlelist,plan);
		    	 
		    }

	}
	function setEditFileStyle(fileId,orlist,titlelist,filename){
	    $("#"+fileId).fileinput({
			language: 'zh', //设置语言
		    uploadUrl: '#', // you must set a valid URL here else you will get an error
		    showRemove: true,
		    overwriteInitial: false,
		    showUpload:false,
		    dropZoneEnabled: false,//是否显示拖拽区域
		    //dropZoneTitle:'拖放文件到这里',
		    maxFileCount: 1,
		    layoutTemplates:{
		    	actionDelete:'',
		    	actionUpload:'',
		    },
		    initialPreview:orlist,
		    initialPreviewAsData: true,
	        initialPreviewConfig: titlelist,
		    slugCallback: function (filename) {
		        return filename.replace('(', '_').replace(']', '_');
		    },
		});
	}
	function setScanFileStyle(fileId,orlist,titlelist,filename){
	    $("#"+fileId).fileinput({
			language: 'zh', //设置语言
		    uploadUrl: '#', // you must set a valid URL here else you will get an error
		    showRemove: true,
		    overwriteInitial: false,
		    showBrowse:false,
		    showUpload:false,
		    dropZoneTitle:'拖放文件到这里',
		    maxFileCount: 1,
		    layoutTemplates:{
		    	actionDelete:'',
		    	actionUpload:'',
		    },
		    initialPreview:orlist,
		    initialPreviewAsData: true,
	        initialPreviewConfig: titlelist,
		    slugCallback: function (filename) {
		        return filename.replace('(', '_').replace(']', '_');
		    },
		});
	}
</script>